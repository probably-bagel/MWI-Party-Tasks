<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MWI - Party Tasks</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #121212;
      color: #fff;
      padding: 20px;
    }
    .header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }
    .refresh-btn {
      background-color: #4caf50;
      border: none;
      color: white;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
    }
    .card {
      background-color: #1e1e1e;
      border-radius: 8px;
      padding: 16px;
      margin: 16px auto;
      max-width: 480px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .task {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .task-icon {
      width: 20px;
      height: 20px;
      margin-right: 8px;
    }
    .task-name {
      font-weight: bold;
    }
    .task-progress {
      margin-left: auto;
    }
    .last-updated {
      font-size: 12px;
      color: #aaa;
      text-align: left;
      margin-top: 5px;
    }

    .cooldown-alert {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: #ff6;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }
    .cooldown-alert.show {
      opacity: 1;
      pointer-events: auto;
    }

  </style>
</head>
<body>
  <div class="header">
    <h1>MWI Party Tasks</h1>
    <button class="refresh-btn">ðŸ”„ Refresh</button>
  </div>
  <div id="dashboard"></div>

  <script>
    const SHARED_BIN_ID = "6809bdf78960c979a58be9d1";
    const API_KEY = "$2a$10$BuzVhO.zxHogPcYrZbMjfu4Mj3hDMuBjKBaFQSt2lGj7zS0bDmXny";

    async function fetchAllUserTasks() {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${SHARED_BIN_ID}/latest`, {
        headers: { 'X-Master-Key': API_KEY }
      });

      if (!res.ok) {
        console.warn(`[MWI] Failed to fetch shared bin (${res.status})`);
        return {};
      }

      const data = await res.json();
      return data.record || {};
    }

    let isCoolingDown = false;
    let cooldownEndsAt = 0;
    const COOLDOWN_MS = 30000; // 30 seconds

    function showCooldownMessage(secondsLeft) {
      const alertBox = document.getElementById('cooldownAlert');
      let remaining = secondsLeft;

      alertBox.textContent = `Stop spamming ho. I'm on the free plan. Try again in ${remaining} sec${remaining !== 1 ? 's' : ''}.`;
      alertBox.classList.add('show');

      const interval = setInterval(() => {
        remaining--;
        if (remaining <= 0) clearInterval(interval);
        else {
          alertBox.textContent = `Stop spamming ho. I'm on the free plan. Try again in ${remaining} sec${remaining !== 1 ? 's' : ''}.`;
        }
      }, 1000);

      setTimeout(() => {
        clearInterval(interval);
        alertBox.classList.remove('show');
      }, 4000);
    }



    async function safeRefreshData() {
      const now = Date.now();
      if (isCoolingDown && now < cooldownEndsAt) {
        const secondsLeft = Math.ceil((cooldownEndsAt - now) / 1000);
        showCooldownMessage(secondsLeft);
        return;
      }

      isCoolingDown = true;
      cooldownEndsAt = now + COOLDOWN_MS;

      await refreshData();

      setTimeout(() => {
        isCoolingDown = false;
      }, COOLDOWN_MS);
    }

    document.querySelector('.refresh-btn').addEventListener('click', safeRefreshData);

    function isCombatTask(task) {
      return /Z\d+/.test(task.name);
    }



    async function refreshData() {
      const container = document.getElementById('dashboard');
      container.innerHTML = '';

      const allData = await fetchAllUserTasks();
      const allCombatTasks = {};

      for (const [username, { tasks = [], slots = null, timestamp = null }] of Object.entries(allData)) {
        tasks.sort((a, b) => {
          const aCombat = isCombatTask(a);
          const bCombat = isCombatTask(b);

          if (aCombat && bCombat) {
            const getZone = name => {
              const match = name.match(/Z(\d+)/);
              return match ? parseInt(match[1], 10) : Infinity;
            };
            return getZone(a.name) - getZone(b.name);
          }

          return bCombat - aCombat; // put combat first
        });

        // collect combat task info
        // collect combat task info grouped by zone
        tasks.forEach(task => {
          const zoneMatch = task.name.match(/Z(\d+)/);
          if (!zoneMatch) return;

          const zone = parseInt(zoneMatch[1], 10);
          if (!allCombatTasks[zone]) {
            allCombatTasks[zone] = { users: new Set(), count: 0, monsters: {} };
          }
          allCombatTasks[zone].users.add(username);
          allCombatTasks[zone].count += 1;

          const match = task.name.match(/Defeat\s*-\s*(.*?)\s*Z\d+/);
          if (match) {
            const monsterName = match[1].trim();
            allCombatTasks[zone].monsters[monsterName] = (allCombatTasks[zone].monsters[monsterName] || 0) + 1;
          }

        });



        // create user card
        const card = document.createElement('div');
        card.className = 'card';

        const headerRow = document.createElement('div');
        headerRow.style.display = 'flex';
        headerRow.style.justifyContent = 'space-between';
        headerRow.style.alignItems = 'center';
        headerRow.style.marginBottom = '12px';

        const nameEl = document.createElement('h2');
        nameEl.textContent = username;
        nameEl.style.margin = 0;

        const slotsEl = document.createElement('div');
        if (slots) {
          slotsEl.textContent = `${slots.current} / ${slots.max} Tasks`;
          slotsEl.style.color = '#aaa';
          slotsEl.style.fontSize = '14px';
        }

        headerRow.appendChild(nameEl);
        headerRow.appendChild(slotsEl);
        card.appendChild(headerRow);

        tasks.forEach(task => {
          const taskEl = document.createElement('div');
          taskEl.className = 'task';

          let iconName;
          if (task.name.startsWith("Defeat")) {
            const match = task.name.match(/Defeat\s*-\s*(.*?)\s*Z\d+/);
            iconName = match ? match[1].trim() : "Defeat";
          } else {
            iconName = task.name.split('-')[0].trim();
          }

          const iconEl = document.createElement('img');
          iconEl.className = 'task-icon';
          iconEl.src = iconName ? `icons/${iconName}.svg` : 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
          iconEl.alt = iconName;

          const label = document.createElement('span');
          label.className = 'task-name';
          label.textContent = task.name;

          const progress = document.createElement('span');
          progress.className = 'task-progress';
          progress.textContent = `${task.progress} / ${task.total}`;

          taskEl.appendChild(iconEl);
          taskEl.appendChild(label);
          taskEl.appendChild(progress);

          card.appendChild(taskEl);
        });

        if (timestamp) {
          const formatted = new Date(timestamp).toLocaleString('en-US', {
            timeZone: 'America/New_York',
            month: '2-digit',
            day: '2-digit',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          });

          const tsEl = document.createElement('div');
          tsEl.className = 'last-updated';
          tsEl.textContent = `(Last updated: ${formatted})`;
          card.appendChild(tsEl);
        }

        container.appendChild(card);
      }

      // render shared combat task table once
      const shared = Object.entries(allCombatTasks)
        .filter(([_, val]) => val.users.size > 1)
        .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));


      const heading = document.createElement('h2');
      heading.textContent = 'ðŸ§  Common Combat Tasks';
      heading.style.textAlign = 'center';
      heading.style.marginTop = '40px';

      const table = document.createElement('table');
      table.style.margin = '16px auto 40px';
      table.style.borderCollapse = 'collapse';
      table.style.fontSize = '14px';

      table.innerHTML = `
        <thead>
          <tr style="border-bottom: 1px solid #555;">
          <th style="padding: 6px 12px; text-align: center;">Zone</th>
          <th style="padding: 6px 12px; text-align: center;">Users</th>
          <th style="padding: 6px 12px; text-align: center;">Total #</th>
          <th style="padding: 6px 12px; text-align: center;">Monsters</th>

          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector('tbody');
      if (shared.length > 0) {
        shared.forEach(([zone, info]) => {
            const monstersHTML = Object.entries(info.monsters).map(([monster, count]) => {

            const countTag = count > 1
              ? `<sup style="position: absolute; top: -6px; right: -6px; font-size: 10px; color: #ccc;">Ã—${count}</sup>`
              : '';
            return `
              <div style="position: relative; display: inline-block; margin: 0 4px;">
                <img src="icons/${monster}.svg" alt="${monster}" title="${monster}" style="width: 20px; height: 20px;" />
                ${countTag}
              </div>
            `;
          }).join('');

          const row = document.createElement('tr');
          row.innerHTML = `
            <td style="padding: 6px 12px; text-align: center;">Zone ${zone}</td>
            <td style="padding: 6px 12px; text-align: center;">${[...info.users].join(', ')}</td>
            <td style="padding: 6px 12px; text-align: center;">${info.count}</td>
            <td style="padding: 6px 12px; text-align: center;">${monstersHTML}</td>
          `;
          tbody.appendChild(row);

        });
      } else {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="3" style="padding: 12px; text-align: center; color: #888;">No matches :(</td>`;
        tbody.appendChild(row);
      }

      container.appendChild(heading);
      container.appendChild(table);
    }

  </script>
<div id="cooldownAlert" class="cooldown-alert"></div>
</body>
</html>
