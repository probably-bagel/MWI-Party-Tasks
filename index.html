<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MWI Party Task Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #121212;
      color: #fff;
      padding: 20px;
    }
    .header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }
    .refresh-btn {
      background-color: #4caf50;
      border: none;
      color: white;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
    }
    .card {
      background-color: #1e1e1e;
      border-radius: 8px;
      padding: 16px;
      margin: 16px auto;
      max-width: 480px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .task {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .task-icon {
      width: 20px;
      height: 20px;
      margin-right: 8px;
    }
    .task-name {
      font-weight: bold;
    }
    .task-progress {
      margin-left: auto;
    }
    .last-updated {
      font-size: 12px;
      color: #aaa;
      text-align: left;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>MWI Party Task Dashboard</h1>
    <button class="refresh-btn" onclick="refreshData()">ðŸ”„ Refresh</button>
  </div>
  <div id="dashboard"></div>

  <script>
    const SHARED_BIN_ID = "6809bdf78960c979a58be9d1";
    const API_KEY = "$2a$10$BuzVhO.zxHogPcYrZbMjfu4Mj3hDMuBjKBaFQSt2lGj7zS0bDmXny";

    async function fetchAllUserTasks() {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${SHARED_BIN_ID}/latest`, {
        headers: { 'X-Master-Key': API_KEY }
      });

      if (!res.ok) {
        console.warn(`[MWI] Failed to fetch shared bin (${res.status})`);
        return {};
      }

      const data = await res.json();
      return data.record || {};
    }

    function isCombatIcon(icon) {
      return icon?.toLowerCase().includes('combat');
    }

    async function refreshData() {
      const container = document.getElementById('dashboard');
      container.innerHTML = '';

      const allData = await fetchAllUserTasks();

      for (const [username, { tasks = [], slots = null, timestamp = null }] of Object.entries(allData)) {
        tasks.sort((a, b) => isCombatIcon(b.icon) - isCombatIcon(a.icon));

        const card = document.createElement('div');
        card.className = 'card';

        const headerRow = document.createElement('div');
        headerRow.style.display = 'flex';
        headerRow.style.justifyContent = 'space-between';
        headerRow.style.alignItems = 'center';
        headerRow.style.marginBottom = '12px';

        const nameEl = document.createElement('h2');
        nameEl.textContent = username;
        nameEl.style.margin = 0;

        const slotsEl = document.createElement('div');
        if (slots) {
          slotsEl.textContent = `${slots.current} / ${slots.max} Tasks`;
          slotsEl.style.color = '#aaa';
          slotsEl.style.fontSize = '14px';
        }

        headerRow.appendChild(nameEl);
        headerRow.appendChild(slotsEl);
        card.appendChild(headerRow);

        tasks.forEach(task => {
          const taskEl = document.createElement('div');
          taskEl.className = 'task';

          const iconName = task.name.split('-')[0].trim();

          const iconEl = document.createElement('img');
          iconEl.className = 'task-icon';
          iconEl.src = iconName ? `icons/${iconName}.svg` : 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
          iconEl.alt = iconName;

          const label = document.createElement('span');
          label.className = 'task-name';
          label.textContent = task.name;

          const progress = document.createElement('span');
          progress.className = 'task-progress';
          progress.textContent = `${task.progress} / ${task.total}`;

          taskEl.appendChild(iconEl);
          taskEl.appendChild(label);
          taskEl.appendChild(progress);

          card.appendChild(taskEl);
        });

        if (timestamp) {
          const formatted = new Date(timestamp).toLocaleString('en-US', {
            timeZone: 'America/New_York',
            month: '2-digit',
            day: '2-digit',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          });

          const tsEl = document.createElement('div');
          tsEl.className = 'last-updated';
          tsEl.textContent = `(Last updated: ${formatted})`;
          card.appendChild(tsEl);
        }

        container.appendChild(card);
      }
    }
  </script>
</body>
</html>
