<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MWI - Party Tasks</title>
  <style>
    /* ====== Base Styles ====== */
    body {
      font-family: sans-serif;
      background-color: #121212;
      color: #fff;
      padding: 20px;
      margin: 0;
    }

    .header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 0px;
    }
    .header h1 {
      font-size: 36px;
      background: linear-gradient(to right, #ffa500, #00d4ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .hide-desktop {
      display: none;
    }

    @media (max-width: 600px) {
      .hide-desktop {
        display: inline;
      }
    }

    .refresh-btn {
      background-color: #4caf50;
      color: white;
      padding: 12px 24px;
      font-size: 15px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s ease;
      min-width: 140px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);

    }


    .refresh-btn:hover {
      background-color: #45a047;
    }

    .main-layout {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      padding-bottom: 100px;
    }

    #dashboard {
      width: 100%;
      max-width: 1500px; 
      margin: 0 auto;
      margin-top: 12px;
      padding: 0 16px;
      box-sizing: border-box;
    }

    .fixed-refresh {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 50px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      transition: background-color 0.2s ease;
      z-index: 1000;
    }

    .fixed-refresh:hover {
      background-color: #45a047;
    }

    /* ====== Card Styles ====== */
    #card-wrapper {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-evenly;
      gap: 24px;
      width: 100%;
    }


    .card {
      background-color: #1e1e1e;
      padding: 20px;
      border-radius: 12px;
      flex: 0 1 30%;
      min-width: 320px;
      max-width: 480px;
      box-sizing: border-box;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }


    .card:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      padding-bottom: 0px;
    }


    .task {
      display: flex;
      align-items: center;
      margin-bottom: 13px;
    }

    .task-icon {
      width: 20px;
      height: 20px;
      margin-right: 8px;
    }

    .task-name {
      font-weight: bold;
    }

    .task-progress {
      margin-left: auto;
      font-size: 13px;
      color: #ccc;
    }

    .zone-highlight {
      color: #ffa500;
      font-weight: bold;
    }

    .common-task {
      background-color: rgba(255, 165, 0, 0.1);
      border-left: 3px solid #ffa500;
      padding-left: 8px;
      border-radius: 4px;
    }

    .last-updated {
      font-size: 11px;
      font-weight: normal;
      color: #888;
      margin-top: 4px;
      display: block;
    }


    /* ====== Summary Table Styles ====== */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 20px;
    }

    th, td {
      padding: 8px 12px;
      text-align: center;
      border-bottom: 1px solid #555;
    }
    .emoji-glow {
      animation: glow 1.5s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { filter: drop-shadow(0 0 0px #ffa500); }
      to   { filter: drop-shadow(0 0 4px #ffa500); }
    }

    .monster-cell {
      display: inline-block;
      text-align: center;
      margin: 3px 5px;
      position: relative;
    }

    .monster-cell img {
      width: 22px;
      height: 22px;
    }

    .monster-cell sup {
      position: absolute;
      top: -7px;
      right: -7px;
      font-size: 11px;
      color: #ccc;
    }

    .remaining-kills {
      font-size: 11px;
      color: #ccc;
      margin-top: 2px;
    }
    .summary-table {
      width: 100%;
      max-width: 350px;
      margin: 0 auto;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .summary-table th{
      padding: 8px;
      text-align: center;
      border-bottom: none;
      vertical-align: top;
      word-wrap: break-word;
    }
    .summary-table td:first-child {
      vertical-align: middle;
      font-weight: bold;
    }
    .summary-table td {
      border-bottom: 1px solid rgba(255,255,255,0.05); /* light divider like cards */
    }

    .summary-table thead th {
      border-bottom: 2px solid rgba(255,255,255,0.1); /* <--- MATCH CARD BORDER */
      font-size: 15px;
      font-weight: 600;
    }
    #summary-section h2 {
      text-align: center;
      margin-bottom: 12px;
      font-weight: 600;
    }

    #summary-section td:first-child {
      vertical-align: middle;
      
    }
    #summary-section {
      background-color: #1e1e1e;
      border-radius: 12px;
      padding: 20px;
      max-width: 1200px; /* ðŸ”¥ match card area */
      margin-bottom: 12px;
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.05);
    }


    #summary-section table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    #summary-section th, #summary-section td {
      padding: 8px;
      text-align: center;
    }


    /* ====== Cooldown Alert ====== */
    .cooldown-alert {
      position: fixed;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: #ff6;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }

    .cooldown-alert.show {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1 class="page-title">
      Milky Way Idle <span class="hide-desktop"><br></span> Party Tasks
    </h1>
  </div>
  
  <div class="main-layout">
    <div id="summary-section"></div>
    <div id="dashboard"></div>
  <button class="fixed-refresh">â†» Refresh</button>

  </div>

  <div id="cooldownAlert" class="cooldown-alert"></div>

  <script>
    // ====== Constants ======
    const SHARED_BIN_ID = "6809bdf78960c979a58be9d1";
    const API_KEY = "$2a$10$BuzVhO.zxHogPcYrZbMjfu4Mj3hDMuBjKBaFQSt2lGj7zS0bDmXny";
    const ALLOWED_USERS = ["Saquon", "ZyzzBraah", "Medusaz"];
    const COOLDOWN_MS = 30000;
    const MONSTER_ZONES = {
      "Fly":1,"Jerry":1,"Skunk":1,"Porcupine":1,"Slimy":1,
      "Frogger":2,"Thnake":2,"Swampy":2,"Sherlock":2,"Giant Shoebill":2,
      "Gary":3,"I Pinch":3,"Aquahorse":3,"Nom Nom":3,"Turuto":3,"Marine Huntress":3,
      "Jungle Sprite":4,"Myconid":4,"Treant":4,"Centaur Archer":4,"Luna Empress":4,
      "Stabby":5,"Slashy":5,"Smashy":5,"Shooty":5,"Boomy":5,"Gobo Chieftain":5,
      "Eye":6,"Eyes":6,"Veyes":6,"The Watcher":6,
      "Novice Sorcerer":7,"Ice Sorcerer":7,"Flame Sorcerer":7,"Elementalist":7,"Chronofrost Sorcerer":7,
      "Gummy Bear":8,"Panda":8,"Black Bear":8,"Grizzler Bear":8,"Polar Bear":8,"Red Panda":8,
      "Magnetic Golem":9,"Stalactite Golem":9,"Granite Golem":9,"Crystal Colossus":9,
      "Zombie":10,"Vampire":10,"WereWolf":10,"Dusk Revenant":10,
      "Abyssal Imp":11,"Soul Hunter":11,"Infernal Warlock":11,"Demonic Overlord":11
    };

    let isCoolingDown = false;
    let cooldownEndsAt = parseInt(localStorage.getItem('MWI_CooldownEndsAt')) || 0;

    // ====== Event Listeners ======
    document.addEventListener("DOMContentLoaded", loadCachedData);
    document.querySelector('.fixed-refresh').addEventListener('click', safeRefreshData);

    // ====== Core Functions ======
    async function safeRefreshData() {
      const now = Date.now();
      if (now < cooldownEndsAt) {
        showCooldownMessage(Math.ceil((cooldownEndsAt - now) / 1000));
        return;
      }

      try {
        isCoolingDown = true;
        cooldownEndsAt = now + COOLDOWN_MS;
        localStorage.setItem('MWI_CooldownEndsAt', cooldownEndsAt.toString());

        const allData = await fetchAllUserTasks();
        localStorage.setItem('MWI_LastDashboardData', JSON.stringify(allData));
        renderData(allData);
      } catch (error) {
        console.error("[MWI] Failed to refresh data:", error);
      } finally {
        setTimeout(() => { isCoolingDown = false; }, COOLDOWN_MS);
      }
    }

    function showCooldownMessage(secondsLeft) {
      const alertBox = document.getElementById('cooldownAlert');
      alertBox.textContent = `Stop spamming ho. Try again in ${secondsLeft} sec${secondsLeft !== 1 ? 's' : ''}.`;
      alertBox.classList.add('show');
      setTimeout(() => alertBox.classList.remove('show'), 4000);
    }


    async function fetchAllUserTasks() {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${SHARED_BIN_ID}/latest`, {
        headers: { 'X-Master-Key': API_KEY }
      });
      if (!res.ok) throw new Error("Failed to fetch tasks");
      const data = await res.json();
      return data.record || {};
    }

    function loadCachedData() {
      const cached = localStorage.getItem("MWI_LastDashboardData");
      if (cached) {
        try {
          renderData(JSON.parse(cached));
        } catch (err) {
          console.warn("[MWI] Failed to load cached dashboard data:", err);
        }
      }
    }

    function renderData(allData) {
      console.log('Rendering data...', allData);
    }
    for (const username of Object.keys(allData)) {
      if (!ALLOWED_USERS.includes(username)) {
        delete allData[username];
      }
    }

    function renderData(allData) {
      const dashboard = document.getElementById('dashboard');
      dashboard.innerHTML = '';

      const cardWrapper = buildUserCards(allData);
      dashboard.appendChild(cardWrapper);

      const allCombatTasks = gatherCombatTasks(allData);
      const sharedZones = Object.entries(allCombatTasks)
        .filter(([_, value]) => value.users.size > 1)
        .sort((a, b) => b[1].count - a[1].count);

      const commonZones = new Set(sharedZones.map(([zone]) => parseInt(zone)));

      highlightCommonTasks(commonZones);
      buildSummaryTable(allData, sharedZones);
    }

    function gatherCombatTasks(allData) {
      const combatTasks = {};

      for (const [username, { tasks = [] }] of Object.entries(allData)) {
        tasks.forEach(task => {
          const zone = getZoneFromTask(task);
          if (zone !== null) {
            if (!combatTasks[zone]) {
              combatTasks[zone] = { users: new Set(), count: 0, monsters: {} };
            }
            combatTasks[zone].users.add(username);
            combatTasks[zone].count++;

            const monster = extractMonsterName(task.name);
            if (monster) {
              combatTasks[zone].monsters[monster] = (combatTasks[zone].monsters[monster] || 0) + 1;
            }
          }
        });
      }

      return combatTasks;
    }

    function buildUserCards(allData) {
      const cardWrapper = document.createElement('div');
      cardWrapper.id = 'card-wrapper';

      for (const [username, { tasks = [], slots = null, timestamp = null }] of Object.entries(allData)) {
        const card = document.createElement('div');
        card.className = 'card';

        const header = document.createElement('div');
        header.className = 'card-header';

        const name = document.createElement('h2');
        name.textContent = username;

        const slotInfo = document.createElement('div');
        slotInfo.textContent = slots ? `${slots.current} / ${slots.max} Tasks` : '';

        header.appendChild(name);
        header.appendChild(slotInfo);
        card.appendChild(header);

        tasks.sort((a, b) => (getZoneFromTask(b) || 0) - (getZoneFromTask(a) || 0));

        tasks.forEach(task => {
          const taskEl = document.createElement('div');
          taskEl.className = 'task';

          const monsterName = extractMonsterName(task.name);
          const zone = getZoneFromTask(task);

          const icon = document.createElement('img');
          icon.className = 'task-icon';
          icon.src = monsterName ? `icons/${monsterName.replace(/ /g, "_")}.svg` : `icons/${task.name.split("-")[0].trim()}.svg`;
          icon.alt = monsterName || task.name;

          const label = document.createElement('span');
          label.className = 'task-name';
          label.innerHTML = zone !== null ? `Defeat - ${monsterName} <span class="zone-highlight">Z${zone}</span>` : task.name;

          const progress = document.createElement('span');
          progress.className = 'task-progress';
          progress.textContent = `${task.progress} / ${task.total}`;

          taskEl.append(icon, label, progress);
          card.appendChild(taskEl);
        });

        if (timestamp) {
          const formatted = new Date(timestamp).toLocaleString('en-US', {
            timeZone: 'America/New_York',
            month: '2-digit',
            day: '2-digit',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          });

          const lastUpdated = document.createElement('div');
          lastUpdated.className = 'last-updated';
          lastUpdated.textContent = `(Last updated: ${formatted})`;
          name.appendChild(lastUpdated);
        }


        cardWrapper.appendChild(card);
      }

      return cardWrapper;
    }

    function highlightCommonTasks(commonZones) {
      document.querySelectorAll('.zone-highlight').forEach(span => {
        const match = span.textContent.match(/Z(\\d+)/);
        if (match && commonZones.has(parseInt(match[1]))) {
          span.closest('.task')?.classList.add('common-task');
        }
      });
    }

    function buildSummaryTable(allData, sharedZones) {
      const summary = document.getElementById('summary-section');
      summary.innerHTML = `
      <h2><span class="emoji-glow">ðŸ§ </span> Common Combat Tasks</h2>
        <table class="summary-table">
          <thead>
            <tr>
              <th>Zone</th>
              <th>Monsters</th>
            </tr>
          </thead>
          <tbody>
            ${sharedZones.map(([zone, info]) => `
              <tr>
                <td><span class="zone-highlight">Z${zone}</span></td>
                <td>${buildMonstersHTML(info.monsters, allData)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function buildMonstersHTML(monsters, allData) {
      return Object.keys(monsters).map(monster => {
        const users = new Set();
        let maxRemaining = 0;

        Object.entries(allData).forEach(([user, { tasks = [] }]) => {
          let userRemaining = 0;
          tasks.forEach(task => {
            const name = extractMonsterName(task.name);
            if (name === monster) {
              users.add(user);
              userRemaining += Math.max((task.total || 0) - (task.progress || 0), 0);
            }
          });
          maxRemaining = Math.max(maxRemaining, userRemaining);
        });

        return `
          <div class="monster-cell" title="Max kills needed: ${maxRemaining}">
            <img src="icons/${monster.replace(/ /g, "_")}.svg" alt="${monster}" title="${monster}">
            ${users.size > 1 ? `<sup title="${users.size} players have this task">Ã—${users.size}</sup>` : ''}
            <div class="remaining-kills" title="Maximum kills required">${maxRemaining}</div>
          </div>
        `;
      }).join('');
    }


    function extractMonsterName(taskName) {
      return taskName.includes("Defeat") ? cleanTaskName(taskName).split('-')[1]?.trim() || null: null;
    }

    function cleanTaskName(taskName) {
      console.log(taskName);
      console.log(taskName.replace(/Z\\d+/g, '').replace(/\\s+/g, ' ').trim());
      return taskName.replace(/Z\d+/g, '').replace(/\s+/g, ' ').trim();
    }

    function getZoneFromTask(task) {
      if (task.name.startsWith('Defeat')) {
        const monster = extractMonsterName(task.name);
        return MONSTER_ZONES[monster] || null;
      }
      return null;
    }

  </script>
</body>
</html>
